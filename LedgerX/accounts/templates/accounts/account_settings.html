{% extends 'base_public.html' %} {% block content %}
<div class="container py-4">
  <div
    class="row mb-4 align-items-center animate__animated animate__fadeInDown"
  >
    <div class="col-12 text-center text-md-start">
      <h2 class="fw-bold h3 mb-1 gradient-text">Account Settings</h2>
      <p class="text-muted small">
        Manage your profile, security, and shop preferences.
      </p>
    </div>
  </div>

  {% if messages %} {% for message in messages %} 
  {% if 'modal_' not in message.tags %}
  <div
    class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm fw-bold small"
    role="alert"
  >
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %} {% endfor %} {% endif %}

  <div class="row g-4">
    <div class="col-lg-5 animate__animated animate__fadeInLeft">
      <div
        class="card border-0 shadow-2xl glass-card h-100 position-relative overflow-hidden"
      >
        <div class="card-body p-4 p-md-5 text-center text-md-start">
          <div class="d-flex flex-column flex-md-row align-items-center mb-4">
            <div
              class="position-relative mb-3 mb-md-0 me-md-4 cursor-pointer hover-scale"
              onclick="openLightbox()"
            >
              <div
                class="rounded-circle shadow-lg overflow-hidden d-flex align-items-center justify-content-center bg-light"
                style="width: 100px; height: 100px"
              >
                {% if request.user.shop.profile_pic %}
                <img
                  src="{{ request.user.shop.profile_pic.url }}"
                  alt="Profile"
                  class="w-100 h-100 object-fit-cover"
                />
                {% else %}
                <div
                  class="fw-bold text-white fs-2 d-flex align-items-center justify-content-center w-100 h-100"
                  style="
                    background: linear-gradient(
                      135deg,
                      #10b981 0%,
                      #059669 100%
                    );
                  "
                >
                  {{ request.user.shop.owner_name|first|upper }}
                </div>
                {% endif %}
              </div>
            </div>

            <div>
              <h4 class="fw-bold mb-1 text-dark">
                {{ request.user.shop.shop_name }}
              </h4>
              <span
                class="badge bg-emerald-subtle text-emerald border border-emerald rounded-pill px-3"
              >
                Active Shop
              </span>
            </div>
          </div>

          <hr class="text-muted opacity-25 my-4" />

          <div class="row g-3">
            <div class="col-12">
              <small
                class="text-muted fw-bold d-block x-small tracking-wider mb-1"
                >SHOP NAME</small
              >
              <p class="fw-bold text-dark fs-6 mb-0">
                {{ request.user.shop.shop_name }}
              </p>
            </div>
            <div class="col-12">
              <small
                class="text-muted fw-bold d-block x-small tracking-wider mb-1"
                >OWNER NAME</small
              >
              <p class="fw-bold text-dark fs-6 mb-0">
                {{ request.user.shop.owner_name }}
              </p>
            </div>
            <div class="col-12">
              <small
                class="text-muted fw-bold d-block x-small tracking-wider mb-1"
                >USERNAME</small
              >
              <p class="fw-bold text-dark fs-6 mb-0">
                @{{ request.user.username }}
              </p>
            </div>
            <div class="col-12">
              <small
                class="text-muted fw-bold d-block x-small tracking-wider mb-1"
                >EMAIL ADDRESS</small
              >
              <p class="fw-bold text-muted mb-0">{{ request.user.email }}</p>
            </div>
          </div>

          <div class="position-absolute bottom-0 end-0 p-4">
            <button
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#editProfileModal"
              class="btn btn-white border shadow-sm rounded-circle p-3 text-emerald hover-scale"
              title="Edit Profile"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-7 animate__animated animate__fadeInRight">
      <div class="card border-0 shadow-sm bg-white rounded-4 mb-4">
        <div class="card-body p-4">
          <h6 class="fw-bold text-muted small mb-3">ACCOUNT ACTIVITY</h6>
          <div
            class="d-flex align-items-center justify-content-between p-3 bg-light rounded-3 mb-2"
          >
            <div class="d-flex align-items-center">
              <span class="fs-5 me-3">üìÖ</span>
              <div>
                <small class="d-block text-muted x-small fw-bold"
                  >JOINED DATE</small
                >
                <span class="text-dark fw-bold small"
                  >{{ request.user.date_joined|date:"F d, Y" }}</span
                >
              </div>
            </div>
          </div>
          <div
            class="d-flex align-items-center justify-content-between p-3 bg-light rounded-3"
          >
            <div class="d-flex align-items-center">
              <span class="fs-5 me-3">üïí</span>
              <div>
                <small class="d-block text-muted x-small fw-bold"
                  >LAST LOGIN</small
                >
                <span class="text-dark fw-bold small">
                  {% if request.user.last_login %}
                  {{request.user.last_login|timesince }} ago {% else %} Just now
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm bg-white rounded-4 overflow-hidden">
        <div class="card-body p-4">
          <h6 class="fw-bold text-muted small mb-3">SECURITY SETTINGS</h6>

          <div
            class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-4 pb-4 border-bottom border-light"
          >
            <div class="mb-3 mb-sm-0">
              <h6 class="fw-bold text-dark mb-1">Change Password</h6>
              <p class="text-muted small mb-0">
                Update your password using your current credentials.
              </p>
            </div>
            <button
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#changePasswordModal"
              class="btn btn-dark fw-bold btn-sm px-4 py-2 rounded-pill shadow-sm"
            >
              Update
            </button>
          </div>

          <div
            class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-4 pb-4 border-bottom border-light"
          >
            <div class="mb-3 mb-sm-0">
              <h6 class="fw-bold text-dark mb-1">Recovery</h6>
              <p class="text-muted small mb-0">
                Forgot your password? Send a recovery link via email.
              </p>
            </div>
            <button
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#recoveryStep1Modal"
              class="btn btn-outline-dark fw-bold btn-sm px-4 py-2 rounded-pill"
            >
              Email Reset
            </button>
          </div>

          <div
            class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center"
          >
            <div class="mb-3 mb-sm-0">
              <h6 class="fw-bold text-danger mb-1">Delete Account</h6>
              <p class="text-danger small mb-0 opacity-75">
                Permanently remove your shop and all data.
              </p>
            </div>
            <a
              href="{% url 'delete_shop_request' %}"
              class="btn btn-danger-subtle fw-bold btn-sm px-4 py-2 rounded-pill text-danger"
            >
              Delete Shop
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-2xl rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                
                {% if messages %}
                    {% for message in messages %}
                        {% if 'modal_edit_profile' in message.tags %}
                            <div class="alert alert-danger small fw-bold shadow-sm mb-3">
                                {{ message }}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                <form id="editProfileForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="profileAction" value="update_profile">

                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <div class="rounded-circle shadow-sm overflow-hidden d-flex align-items-center justify-content-center bg-light" 
                                 style="width: 80px; height: 80px;">
                                
                                <img src="{% if request.user.shop.profile_pic %}{{ request.user.shop.profile_pic.url }}{% endif %}" 
                                     id="editPreview" 
                                     class="w-100 h-100 object-fit-cover {% if not request.user.shop.profile_pic %}d-none{% endif %}">
                                
                                <div id="initialsView" 
                                     class="fw-bold text-white fs-3 d-flex align-items-center justify-content-center w-100 h-100 {% if request.user.shop.profile_pic %}d-none{% endif %}"
                                     style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                    {{ request.user.shop.owner_name|first|upper }}
                                </div>
                            </div>

                            <label for="id_profile_pic" class="position-absolute bottom-0 end-0 bg-white rounded-circle shadow-sm p-1 cursor-pointer border" style="transform: translate(20%, 20%);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                            </label>
                            <input type="file" name="profile_pic" id="id_profile_pic" class="d-none" accept="image/*" onchange="previewImage(this)">
                        </div>
                        
                        {% if request.user.shop.profile_pic %}
                        <div class="mt-2">
                            <button type="button" onclick="triggerRemovePhoto()" class="btn btn-link text-danger text-decoration-none small fw-bold p-0">
                                Remove Photo
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">SHOP NAME</label>
                        <input type="text" name="shop_name" class="form-control" value="{{ request.user.shop.shop_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">OWNER NAME</label>
                        <input type="text" name="owner_name" class="form-control" value="{{ request.user.shop.owner_name }}" required>
                    </div>
                    <div class="mb-3">
    <label class="form-label small fw-bold text-muted">USERNAME</label>
    
    <input type="text" 
           name="username" 
           id="id_username" 
           class="form-control" 
           value="{{ request.user.username }}" 
           onkeyup="checkUsername()" 
           required>
           
    <div id="usernameError" class="text-danger small fw-bold mt-1 d-none">
        <i class="me-1">‚ö†Ô∏è</i> This username is already taken.
    </div>
</div>

<button type="submit" id="saveProfileBtn" class="btn btn-primary w-100 py-3 fw-bold rounded-3 mt-2">
    Save Changes
</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div
  class="modal fade"
  id="recoveryStep1Modal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-2xl rounded-4">
      <div class="modal-header border-0 pb-0 pt-4 px-4">
        <div>
          <h5 class="modal-title fw-bold text-dark">Email Recovery</h5>
          <p class="text-muted small mb-0">Send code to registered email.</p>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="send_recovery_otp" />
          <div class="mb-4">
            <label class="form-label small fw-bold text-muted">EMAIL</label>
            <input
              type="text"
              class="form-control bg-light text-muted border-0 fw-bold"
              value="{{ request.user.email }}"
              readonly
            />
          </div>
          <div class="d-grid">
            <button
              type="submit"
              class="btn btn-primary py-3 fw-bold rounded-3"
            >
              Send Recovery Code
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="recoveryStep2Modal"
  tabindex="-1"
  aria-hidden="true"
  data-bs-backdrop="static"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-2xl rounded-4">
      <div class="modal-header border-0 pb-0 pt-4 px-4">
        <div>
          <h5 class="modal-title fw-bold text-dark">Verify Identity</h5>
          <p class="text-muted small mb-0">
            Enter the 6-digit code sent to you.
          </p>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="verify_recovery_otp" />
          <div class="mb-4">
            <input
              type="text"
              name="otp"
              class="form-control form-control-lg text-center fw-bold letter-spacing-lg"
              placeholder="------"
              maxlength="6"
              required
            />
          </div>
          <div class="d-grid">
            <button
              type="submit"
              class="btn btn-primary py-3 fw-bold rounded-3"
            >
              Verify Code
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="recoveryStep3Modal"
  tabindex="-1"
  aria-hidden="true"
  data-bs-backdrop="static"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-2xl rounded-4">
      <div class="modal-header border-0 pb-0 pt-4 px-4">
        <div>
          <h5 class="modal-title fw-bold text-dark">Reset Password</h5>
          <p class="text-muted small mb-0">Set your new password.</p>
        </div>
      </div>
      <div class="modal-body p-4">
        <form method="post">
          {% csrf_token %}
          <input
            type="hidden"
            name="action"
            value="set_new_password_recovery"
          />
          <div class="mb-3">
            <input
              type="password"
              name="new_password"
              class="form-control"
              placeholder="New Password"
              required
            />
          </div>
          <div class="mb-4">
            <input
              type="password"
              name="confirm_password"
              class="form-control"
              placeholder="Confirm Password"
              required
            />
          </div>
          <div class="d-grid">
            <button
              type="submit"
              class="btn btn-success py-3 fw-bold rounded-3"
            >
              Reset Password
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="changePasswordModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-2xl rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-dark">Change Password</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-4">
        {% if messages %} {% for message in messages %}
         {% if 'modal_change_password' in message.tags %}
        <div class="alert alert-danger small fw-bold shadow-sm mb-3">
          <i class="me-2">‚ö†Ô∏è</i> {{ message }}
        </div>
        {% endif %} {% endfor %} {% endif %}
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="change_password" />

          <div class="mb-3">
            <label class="form-label small fw-bold text-muted"
              >OLD PASSWORD</label
            >
            <input
              type="password"
              name="old_password"
              class="form-control"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted"
              >NEW PASSWORD</label
            >
            <input
              type="password"
              name="new_password"
              class="form-control"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>
          <div class="mb-4">
            <label class="form-label small fw-bold text-muted"
              >CONFIRM NEW PASSWORD</label
            >
            <input
              type="password"
              name="confirm_password"
              class="form-control"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>

          <button
            type="submit"
            class="btn btn-dark w-100 py-3 fw-bold rounded-3"
          >
            Update Password
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="imageLightbox" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-transparent border-0">
      <div
        class="modal-body text-center position-relative d-flex justify-content-center"
      >
        <button
          type="button"
          class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>

        {% if request.user.shop.profile_pic %}
        <div
          class="rounded-circle shadow-2xl overflow-hidden d-flex align-items-center justify-content-center bg-light mx-auto"
          style="width: 300px; height: 300px"
        >
          <img
            src="{{ request.user.shop.profile_pic.url }}"
            class="w-100 h-100 object-fit-cover"
            alt="Profile Picture"
          />
        </div>
        {% else %}
        <div
          class="rounded-circle shadow-2xl d-flex align-items-center justify-content-center text-white display-1 fw-bold mx-auto"
          style="
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          "
        >
          {{ request.user.shop.owner_name|first|upper }}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  :root {
    --primary-emerald: #10b981;
    --emerald-glow: rgba(16, 185, 129, 0.2);
  }
  .text-emerald {
    color: var(--primary-emerald);
  }
  .bg-emerald-subtle {
    background-color: rgba(16, 185, 129, 0.1);
  }
  .border-emerald {
    border-color: rgba(16, 185, 129, 0.3) !important;
  }
  .x-small {
    font-size: 0.7rem;
  }
  .tracking-wider {
    letter-spacing: 0.08em;
  }
  .gradient-text {
    background: linear-gradient(135deg, #111827 0%, #374151 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.9) !important;
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.4) !important;
    border-radius: 1rem;
  }
  .hover-scale {
    transition: transform 0.2s;
  }
  .hover-scale:hover {
    transform: scale(1.05);
  }
  .btn-primary {
    background-color: var(--primary-emerald);
    border-color: var(--primary-emerald);
  }
  .btn-primary:hover {
    background-color: #059669;
    border-color: #059669;
  }
  .btn-danger-subtle {
    background-color: #fef2f2;
    border: 1px solid #fee2e2;
  }
  .btn-danger-subtle:hover {
    background-color: #fee2e2;
    border-color: #fecaca;
  }
  .form-control:focus {
    box-shadow: 0 0 0 3px var(--emerald-glow);
    border-color: var(--primary-emerald);
  }
  .object-fit-cover {
    object-fit: cover;
  }
  .shadow-2xl {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08) !important;
  }
  .cursor-pointer {
    cursor: pointer;
  }

  .letter-spacing-lg {
    letter-spacing: 5px;
    font-size: 1.5rem;
  }
</style>

<script>
  function openLightbox() {
      new bootstrap.Modal(document.getElementById('imageLightbox')).show();
  }

  function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function(e) {
                var previewImg = document.getElementById('editPreview');
                var initialsDiv = document.getElementById('initialsView');

                if (previewImg) {
                    // Set the new image
                    previewImg.src = e.target.result;
                    // Show the image tag
                    previewImg.classList.remove('d-none');
                }
                
                if (initialsDiv) {
                    // Hide the initials div
                    initialsDiv.classList.add('d-none');
                }
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

  // üöÄ AUTOMATICALLY OPEN MODALS BASED ON BACKEND CONTEXT
  document.addEventListener("DOMContentLoaded", function() {

        // 1. RECOVERY FLOW (Keep existing logic for OTP)
        {% if show_otp_modal %}
            new bootstrap.Modal(document.getElementById('recoveryStep2Modal')).show();
        {% endif %}
        {% if show_reset_modal %}
            new bootstrap.Modal(document.getElementById('recoveryStep3Modal')).show();
        {% endif %}

        // 2. CHECK MESSAGES FOR TAGS TO AUTO-OPEN MODALS
        {% if messages %}
            {% for message in messages %}

                // If Profile Error -> Open Profile Modal
                {% if 'modal_edit_profile' in message.tags %}
                    var profileModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
                    profileModal.show();
                {% endif %}

                // If Password Error -> Open Password Modal
                {% if 'modal_change_password' in message.tags %}
                    var passModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                    passModal.show();
                {% endif %}

            {% endfor %}
        {% endif %}
    });

    // Auto-Open Modal on Error (Checks for tags)
    document.addEventListener("DOMContentLoaded", function() {
        {% if messages %}
            {% for message in messages %}
                {% if 'modal_edit_profile' in message.tags %}
                    new bootstrap.Modal(document.getElementById('editProfileModal')).show();
                {% endif %}
                {% if 'modal_change_password' in message.tags %}
                    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
                {% endif %}
            {% endfor %}
        {% endif %}
    });

    function triggerRemovePhoto() {
        if (confirm("Are you sure you want to remove your profile photo?")) {
            // Change the hidden action field to 'remove_photo'
            document.getElementById('profileAction').value = 'remove_photo';
            // Submit the form
            document.getElementById('editProfileForm').submit();
        }
    }

    let typingTimer;                
    const doneTypingInterval = 500;  // Wait 500ms after typing stops

    function checkUsername() {
        clearTimeout(typingTimer);
        const usernameInput = document.getElementById('id_username');
        const errorDiv = document.getElementById('usernameError');
        const saveBtn = document.getElementById('saveProfileBtn');
        const username = usernameInput.value;

        // Reset state while typing
        usernameInput.classList.remove('is-invalid', 'is-valid');
        errorDiv.classList.add('d-none');
        saveBtn.disabled = false;

        if (username) {
            typingTimer = setTimeout(() => {
                // Call our new Django API
                fetch(`{% url 'check_username' %}?username=${username}`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_taken) {
                        // Username Taken: Show Error & Disable Button
                        usernameInput.classList.add('is-invalid');
                        errorDiv.classList.remove('d-none');
                        saveBtn.disabled = true;
                    } else {
                        // Username Available: Show Green Border
                        usernameInput.classList.add('is-valid');
                        saveBtn.disabled = false;
                    }
                });
            }, doneTypingInterval);
        }
    }
</script>
{% endblock %}
